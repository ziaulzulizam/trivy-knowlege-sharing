#!/bin/bash
# build-and-scan.sh - Build the vulnerable PHP application and run Trivy scans

echo "=== Building Vulnerable PHP Application ==="

# Build the vulnerable image
echo "Building Docker image..."
docker build -t vulnerable-php-app:latest .

# Tag for registry (replace with your registry)
echo "Tagging image for registry..."
docker tag vulnerable-php-app:latest myregistry/vulnerable-php-app:v1.0.0

echo "Image built successfully!"

echo ""
echo "=== Running Trivy Scans ==="

echo "1. Basic vulnerability scan:"
trivy image vulnerable-php-app:latest

echo ""
echo "2. Scan with severity filtering (CRITICAL and HIGH only):"
trivy image --severity CRITICAL,HIGH vulnerable-php-app:latest

echo ""
echo "3. Generating JSON report..."
trivy image --format json --output vulnerability-report.json vulnerable-php-app:latest
echo "JSON report saved to: vulnerability-report.json"

echo ""
echo "4. Generating SARIF report for GitHub Security..."
trivy image --format sarif --output trivy-results.sarif vulnerable-php-app:latest
echo "SARIF report saved to: trivy-results.sarif"

echo ""
echo "5. Generating HTML report..."
trivy image --format template --template '@/contrib/html.tpl' --output vulnerability-report.html vulnerable-php-app:latest
echo "HTML report saved to: vulnerability-report.html"

echo ""
echo "6. Scanning for secrets..."
trivy image --scanners secret vulnerable-php-app:latest

echo ""
echo "=== Scan Complete ==="
echo "To push to registry, run:"
echo "docker push myregistry/vulnerable-php-app:v1.0.0"

echo ""
echo "To run the application:"
echo "docker run -p 8080:80 vulnerable-php-app:latest"